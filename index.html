<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>GymCount</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-color: #f5f7fa;
      --text-color: #2d3748;
      --card-bg: #ffffff;
      --border-color: #e2e8f0;
      --shadow-color: rgba(0,0,0,0.1);
      --chart-bg: #ffffff;
      --primary-color: #4299e1;
      --success-color: #48bb78;
      --danger-color: #f56565;
      --accent-color: #805ad5;
      --gradient-start: #4299e1;
      --gradient-end: #805ad5;
    }

    [data-theme="dark"] {
      --bg-color: #1a202c;
      --text-color: #e2e8f0;
      --card-bg: #2d3748;
      --border-color: #4a5568;
      --shadow-color: rgba(0,0,0,0.3);
      --chart-bg: #2d3748;
      --primary-color: #63b3ed;
      --success-color: #68d391;
      --danger-color: #fc8181;
      --accent-color: #b794f4;
      --gradient-start: #63b3ed;
      --gradient-end: #b794f4;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Inter', sans-serif;
      padding: 1.5em;
      max-width: 800px;
      margin: auto;
      background-color: var(--bg-color);
      color: var(--text-color);
      transition: background-color 0.3s, color 0.3s;
      line-height: 1.5;
    }

    h2, h3 {
      font-weight: 600;
      margin-bottom: 1em;
      color: var(--text-color);
      position: relative;
      padding-bottom: 0.5em;
    }

    h2::after, h3::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      width: 50px;
      height: 3px;
      background: linear-gradient(to right, var(--gradient-start), var(--gradient-end));
      border-radius: 3px;
    }

    input, select, button {
      display: block;
      margin: 0.75em 0;
      width: 100%;
      padding: 0.75em;
      font-size: 1em;
      background-color: var(--card-bg);
      color: var(--text-color);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      font-family: 'Inter', sans-serif;
      transition: all 0.2s ease;
    }

    input:focus, select:focus, button:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.2);
    }

    button {
      display: block;
      margin: 0.75em 0;
      width: 100%;
      padding: 0.75em;
      font-size: 1em;
      background: linear-gradient(to right, var(--gradient-start), var(--gradient-end));
      color: white;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 500;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px var(--shadow-color);
    }

    .theme-toggle {
      position: fixed;
      top: 1em;
      right: 1em;
      width: auto;
            padding: 0.5em;      border-radius: 50%;
      font-size: 0.9em;
      z-index: 1000;
      background-color: var(--card-bg);
      color: var(--text-color);
      border: 1px solid var(--border-color);
      box-shadow: 0 2px 4px var(--shadow-color);
    }

    .ejercicio-container {
      margin-bottom: 1.5em;
      background: var(--card-bg);
      padding: 1.5em;
      border-radius: 16px;
      box-shadow: 0 4px 6px var(--shadow-color);
      border: 1px solid var(--border-color);
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .ejercicio-container:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 12px var(--shadow-color);
    }

    .categorias-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 0.75em;
      margin: 1em 0;
    }

    .categoria-btn {
      text-align: left;
      padding: 0.75em 1em;
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      transition: all 0.2s;
      cursor: pointer;
      font-size: 0.9em;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.5em;
      position: relative;
      overflow: hidden;
    }

    .categoria-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(to right, var(--gradient-start), var(--gradient-end));
      opacity: 0;
      transition: opacity 0.2s;
      z-index: 0;
    }

    .categoria-btn.activo::before {
      opacity: 1;
    }

    .categoria-btn.activo {
      color: white;
      border-color: transparent;
    }

    .categoria-nombre {
      position: relative;
      z-index: 1;
    }

    .editar-icono {
      position: relative;
      z-index: 1;
      opacity: 0;
      transition: opacity 0.2s;
      font-size: 0.9em;
      cursor: pointer;
      padding: 0.3em;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 6px;
    }

    .categoria-btn:hover .editar-icono {
      opacity: 1;
    }

    .editar-icono:hover {
      color: var(--primary-color);
    }

    .modal-edicion-categoria .acciones-container {
      display: flex;
      gap: 1em;
      margin-top: 1em;
    }

    .modal-edicion-categoria .acciones-container button {
      flex: 1;
    }

    .modal-edicion-categoria .acciones-container button.borrar {
      background: var(--danger-color);
    }

    .modal-edicion-categoria .acciones-container button.borrar:hover {
      background: var(--danger-color);
      opacity: 0.9;
    }

    .modal-edicion-categoria {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }

    .modal-edicion-categoria .modal-contenido {
      background: var(--card-bg);
      padding: 1.5em;
      border-radius: 12px;
      width: 90%;
      max-width: 400px;
      box-shadow: 0 4px 6px var(--shadow-color);
    }

    .modal-edicion-categoria .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1em;
    }

    .modal-edicion-categoria .cerrar-modal {
      background: none;
      border: none;
      color: var(--text-color);
      font-size: 1.5em;
      cursor: pointer;
      padding: 0.2em;
      width: auto;
    }

    .ejercicios-guardados {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 0.75em;
      margin-top: 1.5em;
    }

    .ejercicio-btn {
      text-align: left;
      padding: 1em;
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 0.5em;
      position: relative;
    }

    .ejercicio-btn .categoria-badge {
      position: absolute;
      top: 0.5em;
      right: 0.5em;
      font-size: 0.7em;
      padding: 0.2em 0.4em;
      border-radius: 4px;
      background: var(--primary-color);
      color: white;
    }

    .ejercicio-btn:hover {
      background-color: var(--primary-color);
      color: white;
      transform: translateY(-2px);
    }

    .registro {
      background: var(--card-bg);
      padding: 1em;
      margin-top: 0.75em;
      border-radius: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 1px 3px var(--shadow-color);
      transition: transform 0.2s;
    }

    .registro:hover {
      transform: translateY(-2px);
    }

    .registro-contenido {
      flex-grow: 1;
    }

    .registro small {
      color: var(--text-color);
      opacity: 0.7;
      font-size: 0.85em;
    }

    .borrar-registro {
      background: none;
      border: none;
      color: var(--danger-color);
      cursor: pointer;
      font-size: 1.2em;
      padding: 0.2em;
      opacity: 0.7;
      transition: all 0.2s;
      width: auto;
    }

    .borrar-registro:hover {
      opacity: 1;
      background: none;
      transform: scale(1.1);
    }

    .volver {
      background: var(--card-bg);
      color: var(--text-color);
      border: 1px solid var(--border-color);
      margin-bottom: 1.5em;
      display: flex;
      align-items: center;
      gap: 0.5em;
      width: auto;
      padding: 0.5em 1em;
    }

    .header-ejercicio, .header-historial {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5em;
      padding: 1em;
      background: var(--card-bg);
      border-radius: 8px;
      box-shadow: 0 2px 4px var(--shadow-color);
    }

    .borrar-ejercicio, .borrar-historial {
      background: none;
      border: none;
      color: var(--danger-color);
      cursor: pointer;
      font-size: 1.5em;
      padding: 0.2em;
      width: auto;
      transition: all 0.2s;
    }

#peso-maximo, #reps-maximas, #total-series {
  font-size: 2em;
}

#ejercicio-actual {
  margin-bottom: 0;
  font-size: 1.5em;
}




    .borrar-ejercicio:hover, .borrar-historial:hover {
      transform: scale(1.1);
      background: none;
    }

    .ultimos-registros {
      margin-top: 2em;
      padding: 1.5em;
      background: var(--card-bg);
      border-radius: 12px;
      box-shadow: 0 4px 6px var(--shadow-color);
    }

    .grafico-dias-categorias {
      margin-top: 2em;
      padding: 1.5em;
      background: var(--card-bg);
      border-radius: 16px;
      box-shadow: 0 4px 6px var(--shadow-color);
      border: 1px solid var(--border-color);
      transition: transform 0.2s;
    }

    .grafico-dias-categorias:hover {
      transform: translateY(-2px);
    }

    .grafico-dias-categorias h3 {
      margin-bottom: 1em;
    }

    .grafico-dias-container {
      height: 300px;
      position: relative;
    }

    .selector-periodo-grafico {
      display: flex;
      gap: 0.5em;
      margin-bottom: 1em;
      background: var(--card-bg);
      padding: 0.5em;
      border-radius: 12px;
      border: 1px solid var(--border-color);
    }

    .periodo-grafico-btn {
      flex: 1;
      padding: 0.75em;
      background: transparent;
      border: none;
      color: var(--text-color);
      cursor: pointer;
      font-size: 0.9em;
      border-radius: 8px;
      transition: all 0.2s;
    }

    .periodo-grafico-btn.activo {
      background: linear-gradient(to right, var(--gradient-start), var(--gradient-end));
      color: white;
    }

    .periodo-grafico-btn:not(.activo):hover {
      background: var(--border-color);
    }

    .registro-reciente {
      background: var(--card-bg);
      padding: 1em;
      margin-bottom: 0.75em;
      border-radius: 8px;
      font-size: 0.95em;
      border: 1px solid var(--border-color);
      transition: transform 0.2s;
    }

    .registro-reciente:hover {
      transform: translateY(-2px);
    }

    .grafico-container {
      margin: 2em 0;
      padding: 1.5em;
      background: var(--chart-bg);
      border-radius: 12px;
      box-shadow: 0 4px 6px var(--shadow-color);
    }

    .peso-corporal-container {
      display: flex;
      align-items: center;
      gap: 0.75em;
      margin: 1em 0;
      padding: 1em;
      background: var(--card-bg);
      border-radius: 8px;
      border: 1px solid var(--border-color);
    }

    .peso-corporal-container input[type="checkbox"] {
      width: 1.2em;
      height: 1.2em;
      margin: 0;
    }

    .fecha-container {
      margin: 1.5em 0;
      padding: 1em;
      background: var(--card-bg);
      border-radius: 8px;
      border: 1px solid var(--border-color);
    }

    .fecha-container label {
      display: block;
      margin-bottom: 0.75em;
      color: var(--text-color);
      font-size: 0.95em;
      font-weight: 500;
    }

    .stats-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 1em;
      margin: 1.5em 0;
    }

    .stat-card {
      background: var(--card-bg);
      padding: 1em;
      border-radius: 8px;
      text-align: center;
      box-shadow: 0 2px 4px var(--shadow-color);
    }

    .stat-value {
      font-size: 1.5em;
      font-weight: 600;
      color: var(--primary-color);
      margin: 0.2em 0;
    }

    .stat-label {
      font-size: 1em;
      color: var(--text-color);
      opacity: 0.8;
    }

    .badge {
      display: inline-block;
      padding: 0.25em 0.5em;
      border-radius: 4px;
      font-size: 0.85em;
      font-weight: 500;
      margin-left: 0.5em;
    }

    .badge-success {
      background-color: var(--primary-color);
      color: white;
    }

    .badge-primary {
      background-color: var(--primary-color);
      color: white;
    }

    @media (max-width: 480px) {
      body {
        padding: 1em;
      }

      .ejercicios-guardados {
        grid-template-columns: 1fr 1fr;
      }

      .stats-container {
        grid-template-columns: 1fr 1fr;
      }

      .categorias-container {
        grid-template-columns: 1fr 1fr;
      }

      .stats-grid {
        grid-template-columns: 1fr;
      }

      .stat-card-avanzada {
        padding: 1.2em;
      }
    }

    .loading {
      opacity: 0.7;
      pointer-events: none;
    }

    .tooltip {
      position: relative;
      display: inline-block;
    }

    .tooltip .tooltiptext {
      visibility: hidden;
      background-color: var(--card-bg);
      color: var(--text-color);
      text-align: center;
      padding: 0.5em 1em;
      border-radius: 6px;
      border: 1px solid var(--border-color);
      box-shadow: 0 2px 4px var(--shadow-color);
      
      position: absolute;
      z-index: 1;
      bottom: 125%;
      left: 50%;
      transform: translateX(-50%);
      
      opacity: 0;
      transition: opacity 0.3s;
    }

    .tooltip:hover .tooltiptext {
      visibility: visible;
      opacity: 1;
    }

    .oculto {
      display: none;
    }

    .pantalla {
      display: none;
    }

    .pantalla.activa {
      display: block;
    }

    /* Ocultar flechas de campos numéricos */
    input[type="number"]::-webkit-outer-spin-button,
    input[type="number"]::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }

    input[type="number"] {
      -moz-appearance: textfield;
    }

    .grafico-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1em;
    }

    .toggle-agrupacion {
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      color: var(--text-color);
      padding: 0.5em 1em;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9em;
      transition: all 0.2s;
    }

    .toggle-agrupacion:hover {
      background: var(--primary-color);
      color: white;
      transform: translateY(-1px);
    }

    .toggle-agrupacion.activo {
      background: var(--primary-color);
      color: white;
    }

    .vista-selector {
      display: flex;
      gap: 0;
      margin: 1.5em 0;
      background: var(--card-bg);
      padding: 0.5em;
      border-radius: 8px;
      border: 1px solid var(--border-color);
    }

    .vista-btn {
      flex: 1;
      background: transparent;
      border: none;
      color: var(--text-color);
      padding: 0.75em;
      margin: 0;
      font-size: 0.9em;
      border-radius: 6px;
      transition: all 0.2s;
    }

    .vista-btn:first-child {
      border-top-right-radius: 0;
      border-bottom-right-radius: 0;
    }

    .vista-btn:last-child {
      border-top-left-radius: 0;
      border-bottom-left-radius: 0;
    }

    .vista-btn.activo {
      background: var(--primary-color);
      color: white;
    }

    .vista-btn:not(.activo):hover {
      background: var(--border-color);
    }

    .tipo-ejercicio-selector {
      display: flex;
      gap: 0;
      margin: 1em 0;
      background: var(--card-bg);
      padding: 0.5em;
      border-radius: 8px;
      border: 1px solid var(--border-color);
    }

    .tipo-btn {
      flex: 1;
      background: transparent;
      border: none;
      color: var(--text-color);
      padding: 0.75em;
      margin: 0;
      font-size: 0.9em;
      border-radius: 6px;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5em;
    }

    .tipo-btn .icono {
      font-size: 1.2em;
    }

    .tipo-btn:first-child {
      border-top-right-radius: 0;
      border-bottom-right-radius: 0;
    }

    .tipo-btn:last-child {
      border-top-left-radius: 0;
      border-bottom-left-radius: 0;
    }

    .tipo-btn.activo {
      background: var(--primary-color);
      color: white;
    }

    .tipo-btn:not(.activo):hover {
      background: var(--border-color);
    }

    .header-ejercicio {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5em;
      padding: 1em;
      background: var(--card-bg);
      border-radius: 8px;
      box-shadow: 0 2px 4px var(--shadow-color);
    }

    .editar-ejercicio {
      background: none;
      border: none;
      color: var(--primary-color);
      cursor: pointer;
      font-size: 1.2em;
      padding: 0.2em;
      width: auto;
      transition: all 0.2s;
    }

    .editar-ejercicio:hover {
      transform: scale(1.1);
      background: none;
    }

    .modal-edicion {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }

    .modal-contenido {
      background: var(--card-bg);
      padding: 2em;
      border-radius: 12px;
      width: 90%;
      max-width: 500px;
      box-shadow: 0 4px 6px var(--shadow-color);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5em;
    }

    .cerrar-modal {
      background: none;
      border: none;
      color: var(--text-color);
      font-size: 1.5em;
      cursor: pointer;
      padding: 0.2em;
      width: auto;
    }

    .modal-categorias {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
      gap: 0.5em;
      margin: 1em 0;
    }

    .modal-categoria-btn {
      text-align: center;
      padding: 0.5em;
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      transition: all 0.2s;
      cursor: pointer;
      font-size: 0.9em;
    }

    .modal-categoria-btn.activo {
      background: var(--primary-color);
      color: white;
      border-color: var(--primary-color);
    }

    .stats-avanzadas {
      margin-top: 2em;
      padding: 1.5em;
      background: var(--card-bg);
      border-radius: 16px;
      box-shadow: 0 4px 6px var(--shadow-color);
      border: 1px solid var(--border-color);
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1em;
      margin-top: 1em;
    }

    .stat-card-avanzada {
      background: var(--card-bg);
      padding: 1.5em;
      border-radius: 12px;
      border: 1px solid var(--border-color);
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .stat-card-avanzada:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px var(--shadow-color);
    }

    .stat-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.5em;
    }

    .stat-header h4 {
      margin: 0;
      font-size: 0.9em;
      color: var(--text-color);
      opacity: 0.8;
    }

    .badge-tendencia {
      font-size: 0.8em;
      padding: 0.2em 0.5em;
      border-radius: 4px;
      background: var(--success-color);
      color: white;
    }

    .badge-tendencia.negativo {
      background: var(--danger-color);
    }

    .stat-content {
      text-align: center;
    }

    .stat-value {
      font-size: 2em;
      font-weight: 600;
      background: linear-gradient(to right, var(--gradient-start), var(--gradient-end));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin: 0.2em 0;
    }

    .stat-label {
      font-size: 0.9em;
      color: var(--text-color);
      opacity: 0.7;
    }

    .grafico-evolucion {
      margin-top: 2em;
      padding: 1.5em;
      background: var(--card-bg);
      border-radius: 16px;
      box-shadow: 0 4px 6px var(--shadow-color);
      border: 1px solid var(--border-color);
      transition: transform 0.2s;
    }

    .grafico-evolucion:hover {
      transform: translateY(-2px);
    }

    .grafico-evolucion-container {
      height: 300px;
      position: relative;
    }

    .objetivo-container {
      display: none;
    }

    .objetivo-input {
      display: none;
    }

    .progreso-objetivo {
      display: none;
    }

    .progreso-item {
      display: none;
    }

    .progreso-label {
      display: none;
    }

    .progreso-bar {
      display: none;
    }

    .progreso-fill {
      display: none;
    }

    .progreso-porcentaje {
      display: none;
    }

    @media (max-width: 480px) {
      .objetivo-input {
        grid-template-columns: 1fr;
      }

      .objetivo-input button {
        grid-column: span 1;
      }
    }

    .exportar-container {
      margin: 1.5em 0;
      padding: 1.5em;
      background: var(--card-bg);
      border-radius: 12px;
      box-shadow: 0 2px 4px var(--shadow-color);
    }

    .exportar-opciones {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 1em;
      margin-top: 1em;
    }

    .exportar-opciones button {
      background: var(--card-bg);
      color: var(--text-color);
      border: 1px solid var(--border-color);
    }

    .exportar-opciones button:hover {
      background: var(--primary-color);
      color: white;
    }
  </style>
</head>
<body>
  <div id="pantalla-seleccion" class="pantalla activa">
    <h2>Selección de Ejercicio</h2>
    
    <div class="ejercicio-container">
      <input type="text" id="ejercicio" placeholder="Nuevo ejercicio" />
      <div class="tipo-ejercicio-selector">
        <button class="tipo-btn activo" data-tipo="repeticiones" onclick="cambiarTipoEjercicio('repeticiones')">
          <span class="icono">🔄</span>
          Repeticiones
        </button>
        <button class="tipo-btn" data-tipo="tiempo" onclick="cambiarTipoEjercicio('tiempo')">
          <span class="icono">⏱️</span>
          Tiempo
        </button>
      </div>
      <div class="nueva-categoria-container">
        <input type="text" id="nueva-categoria" placeholder="Nueva categoría" />
        <button onclick="agregarCategoria()">Agregar</button>
      </div>
      <div class="categorias-container" id="categorias-container">
        <!-- Las categorías se cargarán dinámicamente -->
      </div>
      <button onclick="continuarARegistro()">Continuar</button>
    </div>

    <div class="ejercicios-guardados">
      <!-- Ejercicios guardados se cargarán dinámicamente -->
    </div>

    <div class="grafico-dias-categorias">
      <h3>Días Entrenados por Categoría</h3>
      <div class="selector-periodo-grafico">
        <button class="periodo-grafico-btn activo" onclick="cambiarPeriodoGrafico('semana')">Última semana</button>
        <button class="periodo-grafico-btn" onclick="cambiarPeriodoGrafico('mes')">Último mes</button>
        <button class="periodo-grafico-btn" onclick="cambiarPeriodoGrafico('historico')">Histórico</button>
      </div>
      <div class="grafico-dias-container">
        <canvas id="graficoDiasCategorias"></canvas>
      </div>
    </div>

    <div class="grafico-evolucion">
      <h3>Evolución Temporal</h3>
      <div class="grafico-evolucion-container">
        <canvas id="graficoEvolucion"></canvas>
      </div>
    </div>
  </div>

  <div id="pantalla-registro" class="pantalla">
    <button class="volver" onclick="volverASeleccion()">← Volver</button>
    
    <div class="header-ejercicio">
      <h3 class="ejercicio-titulo" id="ejercicio-actual"></h3>
      <div>
        <button class="editar-ejercicio" onclick="mostrarModalEdicion()" aria-label="Editar ejercicio">✏️</button>
        <button class="borrar-ejercicio" onclick="confirmarBorrarEjercicio()" aria-label="Borrar ejercicio">🗑️</button>
      </div>
    </div>

    <div class="stats-container">
      <div class="stat-card tooltip">
        <div class="stat-label">Peso Máximo</div>
        <div class="stat-value" id="peso-maximo">-</div>
        <span class="tooltiptext">El peso más alto registrado</span>
      </div>
      <div class="stat-card tooltip">
        <div class="stat-label" id="valor-maximo-label">Reps Máximas</div>
        <div class="stat-value" id="valor-maximo">-</div>
        <span class="tooltiptext" id="valor-maximo-tooltip">Las repeticiones más altas registradas</span>
      </div>
      <div class="stat-card tooltip">
        <div class="stat-label">Total Series</div>
        <div class="stat-value" id="total-series">-</div>
        <span class="tooltiptext">Número total de series registradas</span>
      </div>
    </div>

    <div class="stats-avanzadas">
      <h3>Estadísticas Avanzadas</h3>
      <div class="stats-grid">
        <div class="stat-card-avanzada">
          <div class="stat-header">
            <h4>Volumen Total</h4>
          </div>
          <div class="stat-content">
            <div class="stat-value" id="volumen-total">-</div>
            <div class="stat-label">kg × reps</div>
          </div>
        </div>
        <div class="stat-card-avanzada">
          <div class="stat-header">
            <h4>1RM Estimado</h4>
          </div>
          <div class="stat-content">
            <div class="stat-value" id="rm-estimado">-</div>
            <div class="stat-label">kg</div>
          </div>
        </div>
        <div class="stat-card-avanzada">
          <div class="stat-header">
            <h4>Progresión Semanal</h4>
          </div>
          <div class="stat-content">
            <div class="stat-value" id="progresion-mensual">-</div>
            <div class="stat-label">kg/semana</div>
          </div>
        </div>
      </div>
    </div>

    <div class="exportar-container">
      <h3>Exportar Datos</h3>
      <div class="exportar-opciones">
        <button onclick="exportarDatos('json')">Exportar JSON</button>
        <button onclick="exportarDatos('csv')">Exportar CSV</button>
        <button onclick="exportarDatos('pdf')">Exportar PDF</button>
      </div>
    </div>

    <input type="number" id="peso" placeholder="Peso (kg)" step="0.5" />
    <input type="number" id="reps" placeholder="Repeticiones" min="1" />

    <div class="fecha-container">
      <label for="fecha">Fecha (opcional)</label>
      <input type="date" id="fecha">
    </div>

    <button onclick="guardarRegistro()">Guardar</button>

    <div class="vista-selector">
      <button class="vista-btn activo" onclick="cambiarVistaGraficos('normal')">Vista detallada</button>
      <button class="vista-btn" onclick="cambiarVistaGraficos('agrupado')">Vista por días</button>
    </div>

    <div class="graficos-container">
      <div class="grafico-container">
        <h3 class="grafico-titulo">Progreso de Repeticiones</h3>
        <canvas id="graficoReps"></canvas>
      </div>

      <div class="grafico-container" id="contenedor-grafico-peso">
        <h3 class="grafico-titulo">Progreso de Peso</h3>
        <canvas id="graficoPeso"></canvas>
      </div>
    </div>

    <div class="header-historial">
      <h3>Historial</h3>
      <button class="borrar-historial" onclick="confirmarBorrarHistorial()" aria-label="Borrar historial">🗑️</button>
    </div>
    <div id="historial"></div>
  </div>

  <div class="modal-edicion" id="modal-edicion">
    <div class="modal-contenido">
      <div class="modal-header">
        <h3>Editar Ejercicio</h3>
        <button class="cerrar-modal" onclick="cerrarModalEdicion()">×</button>
      </div>
      <input type="text" id="nuevo-nombre" placeholder="Nuevo nombre del ejercicio" />
      <div class="modal-categorias">
        <button class="modal-categoria-btn" data-categoria="pecho" onclick="seleccionarCategoriaEdicion('pecho')">Pecho</button>
        <button class="modal-categoria-btn" data-categoria="espalda" onclick="seleccionarCategoriaEdicion('espalda')">Espalda</button>
        <button class="modal-categoria-btn" data-categoria="piernas" onclick="seleccionarCategoriaEdicion('piernas')">Piernas</button>
        <button class="modal-categoria-btn" data-categoria="hombros" onclick="seleccionarCategoriaEdicion('hombros')">Hombros</button>
        <button class="modal-categoria-btn" data-categoria="brazos" onclick="seleccionarCategoriaEdicion('brazos')">Brazos</button>
        <button class="modal-categoria-btn" data-categoria="core" onclick="seleccionarCategoriaEdicion('core')">Core</button>
        <button class="modal-categoria-btn" data-categoria="cardio" onclick="seleccionarCategoriaEdicion('cardio')">Cardio</button>
        <button class="modal-categoria-btn" data-categoria="otro" onclick="seleccionarCategoriaEdicion('otro')">Otro</button>
      </div>
      <button onclick="guardarEdicionEjercicio()">Guardar Cambios</button>
    </div>
  </div>

  <div class="modal-edicion-categoria" id="modal-edicion-categoria">
    <div class="modal-contenido">
      <div class="modal-header">
        <h3>Editar Categoría</h3>
        <button class="cerrar-modal" onclick="cerrarModalEdicionCategoria()">×</button>
      </div>
      <input type="text" id="nuevo-nombre-categoria" placeholder="Nuevo nombre de la categoría" />
      <div class="acciones-container">
        <button onclick="guardarEdicionCategoria()">Guardar Cambios</button>
        <button class="borrar" onclick="borrarCategoria(categoriaEnEdicion)">Borrar Categoría</button>
      </div>
    </div>
  </div>

  <script>
    let ejercicioSeleccionado = '';
    let tipoEjercicioSeleccionado = 'repeticiones';
    let categoriaSeleccionada = '';
    let graficoReps = null;
    let graficoPeso = null;
    let graficosAgrupados = false;
    let categoriaEdicionSeleccionada = '';
    let categoriaEnEdicion = '';
    let graficoDiasCategorias = null;
    let periodoGrafico = 'semana';

    const cambiarTipoEjercicio = (tipo) => {
      tipoEjercicioSeleccionado = tipo;
      const botones = document.querySelectorAll('.tipo-btn');
      botones.forEach(btn => {
        btn.classList.toggle('activo', btn.dataset.tipo === tipo);
      });
    };

    const cargarCategorias = () => {
      const categorias = JSON.parse(localStorage.getItem('categorias') || "[]");
      const contenedor = document.getElementById('categorias-container');
      
      contenedor.innerHTML = categorias.map(categoria => `
        <button class="categoria-btn ${categoria === categoriaSeleccionada ? 'activo' : ''}" 
                onclick="seleccionarCategoria('${categoria}')">
          <div class="categoria-nombre">${categoria}</div>
          <span class="editar-icono" onclick="mostrarModalEdicionCategoria('${categoria}', event)">✏️</span>
        </button>
      `).join('');
    };

    const agregarCategoria = () => {
      const input = document.getElementById('nueva-categoria');
      const categoria = input.value.trim();
      
      if (!categoria) {
        alert('Por favor, ingresa un nombre para la categoría');
        return;
      }

      const categorias = JSON.parse(localStorage.getItem('categorias') || "[]");
      
      if (categorias.includes(categoria)) {
        alert('Esta categoría ya existe');
        return;
      }

      categorias.push(categoria);
      localStorage.setItem('categorias', JSON.stringify(categorias));
      
      input.value = '';
      cargarCategorias();
    };

    const borrarCategoria = (categoria) => {
      if (confirm(`¿Estás seguro de que quieres borrar la categoría "${categoria}"?`)) {
        const categorias = JSON.parse(localStorage.getItem('categorias') || "[]");
        const nuevaCategorias = categorias.filter(c => c !== categoria);
        localStorage.setItem('categorias', JSON.stringify(nuevaCategorias));
        
        // Actualizar ejercicios que usaban esta categoría
        const ejercicios = JSON.parse(localStorage.getItem('ejerciciosGuardados') || "[]");
        ejercicios.forEach(ejercicio => {
          if (ejercicio.categoria === categoria) {
            ejercicio.categoria = '';
          }
        });
        localStorage.setItem('ejerciciosGuardados', JSON.stringify(ejercicios));
        
        if (categoriaSeleccionada === categoria) {
          categoriaSeleccionada = '';
        }
        
        cerrarModalEdicionCategoria();
        cargarCategorias();
        actualizarBotonesEjercicios();
      }
    };

    const seleccionarCategoria = (categoria) => {
      categoriaSeleccionada = categoria;
      cargarCategorias();
      filtrarEjerciciosPorCategoria(categoria);
    };

    const filtrarEjerciciosPorCategoria = (categoria) => {
      const ejercicios = JSON.parse(localStorage.getItem('ejerciciosGuardados') || "[]");
      const ejerciciosFiltrados = categoria === '' ? 
        ejercicios : 
        ejercicios.filter(e => e.categoria === categoria);
      
      const contenedor = document.querySelector('.ejercicios-guardados');
      contenedor.innerHTML = ejerciciosFiltrados.map(ejercicio => 
        `<button class="ejercicio-btn" onclick="seleccionarEjercicio('${ejercicio.nombre}')">
          ${ejercicio.nombre}
          <span class="badge badge-${ejercicio.tipo === 'tiempo' ? 'primary' : 'success'}">
            ${ejercicio.tipo === 'tiempo' ? '⏱️' : '🔄'}
          </span>
          ${ejercicio.categoria ? `<span class="categoria-badge">${ejercicio.categoria}</span>` : ''}
        </button>`
      ).join('');
    };

    const mostrarUltimosRegistros = () => {
      actualizarGraficoDiasCategorias();
      actualizarEstadisticasAvanzadas();
      actualizarGraficoEvolucion();
    };

    const mostrarPantalla = (id) => {
      document.querySelectorAll('.pantalla').forEach(p => p.classList.remove('activa'));
      document.getElementById(id).classList.add('activa');
      if (id === 'pantalla-seleccion') {
        mostrarUltimosRegistros();
      }
    };

    const seleccionarEjercicio = (nombre) => {
      const ejercicios = JSON.parse(localStorage.getItem('ejerciciosGuardados') || "[]");
      const ejercicio = ejercicios.find(e => e.nombre === nombre);
      
      if (ejercicio) {
        ejercicioSeleccionado = ejercicio.nombre;
        tipoEjercicioSeleccionado = ejercicio.tipo;
        categoriaSeleccionada = ejercicio.categoria || 'otro';
        document.getElementById('ejercicio-actual').textContent = ejercicio.nombre;
        
        actualizarInterfazPorTipo(ejercicio.tipo);
        
        mostrarHistorial();
        mostrarPantalla('pantalla-registro');
      }
    };

    const actualizarInterfazPorTipo = (tipo) => {
      const repsInput = document.getElementById('reps');
      const valorMaximoLabel = document.getElementById('valor-maximo-label');
      const valorMaximoTooltip = document.getElementById('valor-maximo-tooltip');
      
      if (tipo === 'tiempo') {
        repsInput.placeholder = 'Tiempo (segundos)';
        valorMaximoLabel.textContent = 'Tiempo Máximo';
        valorMaximoTooltip.textContent = 'El tiempo más largo registrado';
      } else {
        repsInput.placeholder = 'Repeticiones';
        valorMaximoLabel.textContent = 'Reps Máximas';
        valorMaximoTooltip.textContent = 'Las repeticiones más altas registradas';
      }
      
      repsInput.step = '1';
      repsInput.min = '1';
    };

    const actualizarBotonesEjercicios = () => {
      filtrarEjerciciosPorCategoria(categoriaSeleccionada);
    };

    const continuarARegistro = () => {
      const ejercicio = document.getElementById('ejercicio').value.trim();
      if (!ejercicio) {
        alert('Por favor, escribe un ejercicio');
        return;
      }

      const ejercicios = JSON.parse(localStorage.getItem('ejerciciosGuardados') || "[]");
      const ejercicioExistente = ejercicios.find(e => e.nombre === ejercicio);
      
      if (ejercicioExistente) {
        if (ejercicioExistente.tipo !== tipoEjercicioSeleccionado) {
          alert('Este ejercicio ya existe con un tipo diferente');
          return;
        }
      } else {
        ejercicios.push({
          nombre: ejercicio,
          tipo: tipoEjercicioSeleccionado,
          categoria: categoriaSeleccionada
        });
        localStorage.setItem('ejerciciosGuardados', JSON.stringify(ejercicios));
      }
      
      ejercicioSeleccionado = ejercicio;
      document.getElementById('ejercicio-actual').textContent = ejercicio;
      document.getElementById('ejercicio').value = '';
      actualizarBotonesEjercicios();
      
      actualizarInterfazPorTipo(tipoEjercicioSeleccionado);
      
      mostrarHistorial();
      mostrarPantalla('pantalla-registro');
    };

    const volverASeleccion = () => {
      mostrarPantalla('pantalla-seleccion');
    };

    const toggleTheme = () => {
      const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
      document.documentElement.setAttribute('data-theme', theme);
      localStorage.setItem('theme', theme);
      actualizarGraficos();
    };

    const loadTheme = () => {
      document.documentElement.setAttribute('data-theme', 'dark');
    };

    const cambiarVistaGraficos = (tipo) => {
      const botones = document.querySelectorAll('.vista-btn');
      botones.forEach(btn => btn.classList.remove('activo'));
      
      if (tipo === 'agrupado') {
        graficosAgrupados = true;
        botones[1].classList.add('activo');
      } else {
        graficosAgrupados = false;
        botones[0].classList.add('activo');
      }
      
      actualizarGraficos();
    };

    const agruparDatosPorDia = (registros) => {
      const datosPorDia = {};
      
      registros.forEach(r => {
        const fecha = r.fecha.split(', ')[0];
        if (!datosPorDia[fecha]) {
          datosPorDia[fecha] = {
            pesos: [],
            valor: 0,
            pesoCorporal: false
          };
        }
        
        if (r.pesoCorporal) {
          datosPorDia[fecha].pesoCorporal = true;
        } else {
          datosPorDia[fecha].pesos.push(parseFloat(r.peso));
        }

        // Para tiempo sumamos, para repeticiones también
        datosPorDia[fecha].valor += parseInt(r.tipo === 'tiempo' ? r.tiempo : r.reps);
      });

      return Object.entries(datosPorDia).map(([fecha, datos]) => ({
        fecha,
        peso: datos.pesoCorporal ? null : 
              datos.pesos.length > 0 ? 
              (datos.pesos.reduce((a, b) => a + b, 0) / datos.pesos.length).toFixed(1) : null,
        [tipoEjercicioSeleccionado === 'tiempo' ? 'tiempo' : 'reps']: datos.valor,
        tipo: tipoEjercicioSeleccionado,
        pesoCorporal: datos.pesoCorporal
      }));
    };

    const actualizarGraficos = () => {
      const isDarkMode = document.documentElement.getAttribute('data-theme') === 'dark';
      const textColor = isDarkMode ? '#ffffff' : '#333333';
      const registros = JSON.parse(localStorage.getItem('registros') || "[]");
      let registrosEjercicio = registros
        .filter(r => r.ejercicio === ejercicioSeleccionado)
        .map(r => {
          const [dia, mes, año] = r.fecha.split('/');
          const fechaObj = new Date(año, mes - 1, dia);
          
          return {
            ...r,
            fechaObj
          };
        })
        .sort((a, b) => a.fechaObj - b.fechaObj);

      if (graficosAgrupados) {
        registrosEjercicio = agruparDatosPorDia(registrosEjercicio);
      }

      const etiquetasFecha = registrosEjercicio.map(r => r.fecha);

      const esTiempo = tipoEjercicioSeleccionado === 'tiempo';
      const labelBase = esTiempo ? 'Tiempo' : 'Repeticiones';
      const unidad = esTiempo ? 'seg' : 'reps';

      const datosValor = {
        labels: etiquetasFecha,
        datasets: [{
          label: graficosAgrupados ? `${labelBase} total` : labelBase,
          data: registrosEjercicio.map(r => esTiempo ? r.tiempo : r.reps),
          borderColor: '#4CAF50',
          backgroundColor: 'rgba(76, 175, 80, 0.1)',
          tension: 0.4,
          fill: true
        }]
      };

      const datosPeso = {
        labels: etiquetasFecha,
        datasets: [{
          label: graficosAgrupados ? 'Peso promedio (kg)' : 'Peso (kg)',
          data: registrosEjercicio.map(r => r.peso),
          borderColor: '#2196F3',
          backgroundColor: 'rgba(33, 150, 243, 0.1)',
          tension: 0.4,
          fill: true
        }]
      };

      if (graficoReps) {
        graficoReps.destroy();
      }
      if (graficoPeso) {
        graficoPeso.destroy();
      }

      const ctxReps = document.getElementById('graficoReps').getContext('2d');
      const ctxPeso = document.getElementById('graficoPeso').getContext('2d');

      graficoReps = new Chart(ctxReps, {
        type: 'line',
        data: datosValor,
        options: {
          responsive: true,
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              mode: 'index',
              intersect: false,
              callbacks: {
                title: (context) => {
                  return context[0].label;
                },
                label: (context) => {
                  const valor = context.raw;
                  return `${labelBase}: ${valor} ${unidad}`;
                }
              }
            }
          },
          scales: {
            x: {
              ticks: {
                maxRotation: 45,
                minRotation: 45,
                color: textColor
              },
              grid: {
                color: isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)'
              }
            },
            y: {
              beginAtZero: true,
              ticks: {
                stepSize: 1,
                color: textColor
              },
              grid: {
                color: isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)'
              },
              title: {
                display: true,
                text: graficosAgrupados ? `${labelBase} total (${unidad})` : `${labelBase} (${unidad})`,
                color: textColor
              }
            }
          }
        }
      });

      graficoPeso = new Chart(ctxPeso, {
        type: 'line',
        data: datosPeso,
        options: {
          responsive: true,
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              mode: 'index',
              intersect: false,
              callbacks: {
                title: (context) => {
                  return context[0].label;
                },
                label: function(context) {
                  const value = context.raw;
                  if (graficosAgrupados) {
                    return `Peso promedio: ${value} kg`;
                  }
                  return 'Peso: ' + value + ' kg';
                }
              }
            }
          },
          scales: {
            x: {
              ticks: {
                maxRotation: 45,
                minRotation: 45,
                color: textColor
              },
              grid: {
                color: isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)'
              }
            },
            y: {
              beginAtZero: true,
              ticks: {
                color: textColor
              },
              grid: {
                color: isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)'
              },
              title: {
                display: true,
                text: graficosAgrupados ? 'Peso promedio (kg)' : 'Peso (kg)',
                color: textColor
              }
            }
          }
        }
      });
    };

    const actualizarEstadisticas = () => {
      const registros = JSON.parse(localStorage.getItem('registros') || "[]");
      const registrosEjercicio = registros.filter(r => r.ejercicio === ejercicioSeleccionado);

      const pesoMaximo = registrosEjercicio
        .reduce((max, r) => Math.max(max, parseFloat(r.peso) || 0), 0);
      
      const valorMaximo = registrosEjercicio
        .reduce((max, r) => Math.max(max, r.tipo === 'tiempo' ? r.tiempo : r.reps || 0), 0);
      
      const totalSeries = registrosEjercicio.length;

      document.getElementById('peso-maximo').textContent = pesoMaximo > 0 ? `${pesoMaximo}kg` : '-';
      document.getElementById('valor-maximo').textContent = valorMaximo > 0 ? 
        `${valorMaximo}${tipoEjercicioSeleccionado === 'tiempo' ? ' seg' : ''}` : '-';
      document.getElementById('total-series').textContent = totalSeries;
    };

    const calcularEstadisticasAvanzadas = () => {
      const registros = JSON.parse(localStorage.getItem('registros') || "[]");
      const registrosEjercicio = registros.filter(r => r.ejercicio === ejercicioSeleccionado);

      // Calcular volumen total
      const volumenTotal = registrosEjercicio.reduce((total, r) => {
        return total + (parseFloat(r.peso) * parseInt(r.reps));
      }, 0);
      document.getElementById('volumen-total').textContent = volumenTotal.toLocaleString();

      // Calcular 1RM estimado (fórmula de Brzycki)
      const calcular1RM = (peso, reps) => {
        return peso * (36 / (37 - reps));
      };

      const rmEstimado = registrosEjercicio.reduce((max, r) => {
        const rm = calcular1RM(parseFloat(r.peso), parseInt(r.reps));
        return Math.max(max, rm);
      }, 0);
      document.getElementById('rm-estimado').textContent = rmEstimado.toFixed(1);

      // Calcular progresión semanal
      const ahora = new Date();
      const semanaAnterior = new Date(ahora.getTime() - 7 * 24 * 60 * 60 * 1000);
      
      const registrosSemanaActual = registrosEjercicio.filter(r => {
        const [dia, mes, año] = r.fecha.split('/');
        const fechaRegistro = new Date(año, mes - 1, dia);
        return fechaRegistro >= semanaAnterior && fechaRegistro <= ahora;
      });

      const registrosSemanaAnterior = registrosEjercicio.filter(r => {
        const [dia, mes, año] = r.fecha.split('/');
        const fechaRegistro = new Date(año, mes - 1, dia);
        const dosSemanasAtras = new Date(ahora.getTime() - 14 * 24 * 60 * 60 * 1000);
        return fechaRegistro >= dosSemanasAtras && fechaRegistro < semanaAnterior;
      });

      const pesoPromedioActual = registrosSemanaActual.length > 0 ?
        registrosSemanaActual.reduce((sum, r) => sum + parseFloat(r.peso), 0) / registrosSemanaActual.length : 0;
      
      const pesoPromedioAnterior = registrosSemanaAnterior.length > 0 ?
        registrosSemanaAnterior.reduce((sum, r) => sum + parseFloat(r.peso), 0) / registrosSemanaAnterior.length : 0;

      const progresion = pesoPromedioActual - pesoPromedioAnterior;
      document.getElementById('progresion-mensual').textContent = progresion.toFixed(1);
    };

    const exportarDatos = (formato) => {
      const registros = JSON.parse(localStorage.getItem('registros') || "[]");
      const registrosEjercicio = registros.filter(r => r.ejercicio === ejercicioSeleccionado);
      
      let contenido = '';
      let nombreArchivo = `${ejercicioSeleccionado}_${new Date().toISOString().split('T')[0]}`;
      let tipoMIME = '';

      switch(formato) {
        case 'json':
          contenido = JSON.stringify(registrosEjercicio, null, 2);
          nombreArchivo += '.json';
          tipoMIME = 'application/json';
          break;
        
        case 'csv':
          const headers = ['Fecha', 'Peso', 'Repeticiones', 'Tipo'];
          const filas = registrosEjercicio.map(r => [
            r.fecha,
            r.peso,
            r.tipo === 'tiempo' ? r.tiempo : r.reps,
            r.tipo
          ]);
          contenido = [headers, ...filas].map(fila => fila.join(',')).join('\n');
          nombreArchivo += '.csv';
          tipoMIME = 'text/csv';
          break;
        
        case 'pdf':
          // Aquí podríamos implementar la generación de PDF
          alert('La exportación a PDF está en desarrollo');
          return;
      }

      const blob = new Blob([contenido], { type: tipoMIME });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = nombreArchivo;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    };

    const mostrarHistorial = () => {
      const contenedor = document.getElementById('historial');
      const registros = JSON.parse(localStorage.getItem('registros') || "[]");
      const registrosEjercicio = registros
        .filter(r => r.ejercicio === ejercicioSeleccionado)
        .sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
      
      contenedor.innerHTML = registrosEjercicio.map(r => {
        const valor = r.tipo === 'tiempo' ? `${r.tiempo} seg` : `${r.reps} reps`;
        
        return `<div class="registro">
          <div class="registro-contenido">
            ${r.peso}kg x ${valor}<br/>
            <small>${r.fecha}</small>
          </div>
          <button class="borrar-registro" onclick="borrarRegistroIndividual('${r.fecha}')" aria-label="Borrar registro">🗑️</button>
        </div>`;
      }).join('');

      actualizarGraficos();
      actualizarEstadisticas();
      calcularEstadisticasAvanzadas();
    };

    const guardarRegistro = () => {
      const peso = document.getElementById('peso').value;
      const valor = document.getElementById('reps').value;
      const fechaInput = document.getElementById('fecha').value;
      
      if (!peso || !valor) {
        alert("Completa todos los campos necesarios");
        return;
      }

      if (parseInt(valor) < 1) {
        alert(tipoEjercicioSeleccionado === 'tiempo' ? 
          "El tiempo debe ser al menos 1 segundo" : 
          "Las repeticiones deben ser al menos 1");
        return;
      }

      let fecha;
      if (fechaInput) {
        const [año, mes, dia] = fechaInput.split('-');
        fecha = `${dia}/${mes}/${año}`;
      } else {
        const hoy = new Date();
        const dia = String(hoy.getDate()).padStart(2, '0');
        const mes = String(hoy.getMonth() + 1).padStart(2, '0');
        const año = hoy.getFullYear();
        fecha = `${dia}/${mes}/${año}`;
      }

      const nuevo = { 
        ejercicio: ejercicioSeleccionado,
        tipo: tipoEjercicioSeleccionado,
        peso,
        [tipoEjercicioSeleccionado === 'tiempo' ? 'tiempo' : 'reps']: parseInt(valor),
        fecha
      };
      
      document.body.classList.add('loading');
      
      setTimeout(() => {
        const registros = JSON.parse(localStorage.getItem('registros') || "[]");
        registros.push(nuevo);
        localStorage.setItem('registros', JSON.stringify(registros));
        
        mostrarHistorial();
        mostrarUltimosRegistros();
        
        document.getElementById('peso').value = '';
        document.getElementById('reps').value = '';
        document.getElementById('fecha').value = '';
        
        document.body.classList.remove('loading');
      }, 300);
    };

    const borrarRegistroIndividual = (fecha) => {
      if (confirm("¿Estás seguro de que quieres borrar este registro?")) {
        const registros = JSON.parse(localStorage.getItem('registros') || "[]");
        const nuevosRegistros = registros.filter(r => 
          !(r.ejercicio === ejercicioSeleccionado && r.fecha === fecha)
        );
        localStorage.setItem('registros', JSON.stringify(nuevosRegistros));
        mostrarHistorial();
        mostrarUltimosRegistros();
      }
    };

    const confirmarBorrarHistorial = () => {
      if (confirm("¿Estás seguro de que quieres borrar todo el historial de este ejercicio?")) {
        const registros = JSON.parse(localStorage.getItem('registros') || "[]");
        const nuevosRegistros = registros.filter(r => r.ejercicio !== ejercicioSeleccionado);
        localStorage.setItem('registros', JSON.stringify(nuevosRegistros));
        mostrarHistorial();
      }
    };

    const confirmarBorrarEjercicio = () => {
      if (confirm("¿Estás seguro de que quieres borrar este ejercicio?")) {
        const ejercicios = JSON.parse(localStorage.getItem('ejerciciosGuardados') || "[]");
        const nuevoEjercicios = ejercicios.filter(e => e.nombre !== ejercicioSeleccionado);
        localStorage.setItem('ejerciciosGuardados', JSON.stringify(nuevoEjercicios));
        actualizarBotonesEjercicios();
        mostrarHistorial();
        mostrarPantalla('pantalla-seleccion');
      }
    };

    const mostrarModalEdicion = () => {
      const modal = document.getElementById('modal-edicion');
      const nuevoNombre = document.getElementById('nuevo-nombre');
      nuevoNombre.value = ejercicioSeleccionado;
      categoriaEdicionSeleccionada = categoriaSeleccionada;
      
      const categorias = JSON.parse(localStorage.getItem('categorias') || "[]");
      const contenedorCategorias = modal.querySelector('.modal-categorias');
      contenedorCategorias.innerHTML = categorias.map(categoria => `
        <button class="modal-categoria-btn ${categoria === categoriaSeleccionada ? 'activo' : ''}" 
                onclick="seleccionarCategoriaEdicion('${categoria}')">
          ${categoria}
        </button>
      `).join('');
      
      modal.style.display = 'flex';
    };

    const cerrarModalEdicion = () => {
      document.getElementById('modal-edicion').style.display = 'none';
    };

    const seleccionarCategoriaEdicion = (categoria) => {
      categoriaEdicionSeleccionada = categoria;
      document.querySelectorAll('.modal-categoria-btn').forEach(btn => {
        btn.classList.toggle('activo', btn.dataset.categoria === categoria);
      });
    };

    const guardarEdicionEjercicio = () => {
      const nuevoNombre = document.getElementById('nuevo-nombre').value.trim();
      
      if (!nuevoNombre) {
        alert('Por favor, ingresa un nombre para el ejercicio');
        return;
      }

      const ejercicios = JSON.parse(localStorage.getItem('ejerciciosGuardados') || "[]");
      
      // Verificar si el nuevo nombre ya existe (excluyendo el ejercicio actual)
      const ejercicioExistente = ejercicios.find(e => 
        e.nombre === nuevoNombre && e.nombre !== ejercicioSeleccionado
      );
      
      if (ejercicioExistente) {
        alert('Ya existe un ejercicio con ese nombre');
        return;
      }

      const ejercicioIndex = ejercicios.findIndex(e => e.nombre === ejercicioSeleccionado);
      
      if (ejercicioIndex !== -1) {
        // Actualizar el ejercicio
        ejercicios[ejercicioIndex].nombre = nuevoNombre;
        ejercicios[ejercicioIndex].categoria = categoriaEdicionSeleccionada;
        
        // Actualizar los registros
        const registros = JSON.parse(localStorage.getItem('registros') || "[]");
        registros.forEach(registro => {
          if (registro.ejercicio === ejercicioSeleccionado) {
            registro.ejercicio = nuevoNombre;
          }
        });
        
        localStorage.setItem('ejerciciosGuardados', JSON.stringify(ejercicios));
        localStorage.setItem('registros', JSON.stringify(registros));
        
        ejercicioSeleccionado = nuevoNombre;
        categoriaSeleccionada = categoriaEdicionSeleccionada;
        
        document.getElementById('ejercicio-actual').textContent = nuevoNombre;
        actualizarBotonesEjercicios();
        mostrarHistorial();
        cerrarModalEdicion();
      }
    };

    const mostrarModalEdicionCategoria = (categoria, event) => {
      event.stopPropagation();
      categoriaEnEdicion = categoria;
      const modal = document.getElementById('modal-edicion-categoria');
      const input = document.getElementById('nuevo-nombre-categoria');
      input.value = categoria;
      modal.style.display = 'flex';
    };

    const cerrarModalEdicionCategoria = () => {
      document.getElementById('modal-edicion-categoria').style.display = 'none';
      categoriaEnEdicion = '';
    };

    const guardarEdicionCategoria = () => {
      const nuevoNombre = document.getElementById('nuevo-nombre-categoria').value.trim();
      
      if (!nuevoNombre) {
        alert('Por favor, ingresa un nombre para la categoría');
        return;
      }

      const categorias = JSON.parse(localStorage.getItem('categorias') || "[]");
      
      if (categorias.includes(nuevoNombre) && nuevoNombre !== categoriaEnEdicion) {
        alert('Ya existe una categoría con ese nombre');
        return;
      }

      // Actualizar la categoría
      const nuevaCategorias = categorias.map(c => 
        c === categoriaEnEdicion ? nuevoNombre : c
      );
      localStorage.setItem('categorias', JSON.stringify(nuevaCategorias));
      
      // Actualizar ejercicios que usaban esta categoría
      const ejercicios = JSON.parse(localStorage.getItem('ejerciciosGuardados') || "[]");
      ejercicios.forEach(ejercicio => {
        if (ejercicio.categoria === categoriaEnEdicion) {
          ejercicio.categoria = nuevoNombre;
        }
      });
      localStorage.setItem('ejerciciosGuardados', JSON.stringify(ejercicios));
      
      if (categoriaSeleccionada === categoriaEnEdicion) {
        categoriaSeleccionada = nuevoNombre;
      }
      
      cerrarModalEdicionCategoria();
      cargarCategorias();
      actualizarBotonesEjercicios();
    };

    const cambiarPeriodoGrafico = (periodo) => {
      periodoGrafico = periodo;
      document.querySelectorAll('.periodo-grafico-btn').forEach(btn => {
        btn.classList.toggle('activo', btn.textContent.toLowerCase().includes(periodo));
      });
      actualizarGraficoDiasCategorias();
    };

    const obtenerDatosPeriodoGrafico = (registros, periodo) => {
      const ahora = new Date();
      let fechaInicio;
      
      switch(periodo) {
        case 'semana':
          fechaInicio = new Date(ahora.getTime() - 7 * 24 * 60 * 60 * 1000);
          break;
        case 'mes':
          fechaInicio = new Date(ahora.getFullYear(), ahora.getMonth(), 1);
          break;
        case 'historico':
          return registros; // Retorna todos los registros
      }

      return registros.filter(r => {
        const [dia, mes, año] = r.fecha.split('/');
        const fechaRegistro = new Date(año, mes - 1, dia);
        return fechaRegistro >= fechaInicio && fechaRegistro <= ahora;
      });
    };

    const actualizarGraficoDiasCategorias = () => {
      // Registrar el plugin de datalabels
      Chart.register(ChartDataLabels);

      const categorias = JSON.parse(localStorage.getItem('categorias') || "[]");
      const ejercicios = JSON.parse(localStorage.getItem('ejerciciosGuardados') || "[]");
      const registros = JSON.parse(localStorage.getItem('registros') || "[]");
      const registrosFiltrados = obtenerDatosPeriodoGrafico(registros, periodoGrafico);
      
      // Calcular días por categoría
      const diasPorCategoria = {};
      categorias.forEach(categoria => {
        const diasUnicos = new Set();
        registrosFiltrados.forEach(registro => {
          const ejercicio = ejercicios.find(e => e.nombre === registro.ejercicio);
          if (ejercicio && ejercicio.categoria === categoria) {
            diasUnicos.add(registro.fecha);
          }
        });
        diasPorCategoria[categoria] = diasUnicos.size;
      });

      const ctx = document.getElementById('graficoDiasCategorias').getContext('2d');
      
      if (graficoDiasCategorias) {
        graficoDiasCategorias.destroy();
      }

      const isDarkMode = document.documentElement.getAttribute('data-theme') === 'dark';
      const textColor = isDarkMode ? '#ffffff' : '#333333';

      // Colores para las categorías
      const colores = [
        '#4299e1', // Azul
        '#48bb78', // Verde
        '#ed8936', // Naranja
        '#9f7aea', // Púrpura
        '#f56565', // Rojo
        '#38b2ac', // Turquesa
        '#ecc94b', // Amarillo
        '#a0aec0', // Gris
        '#4fd1c5', // Verde azulado
        '#f6ad55'  // Naranja claro
      ];

      graficoDiasCategorias = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: categorias,
          datasets: [{
            data: categorias.map(c => diasPorCategoria[c]),
            backgroundColor: colores,
            borderWidth: 2,
            borderColor: isDarkMode ? '#2d3748' : '#ffffff'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'right',
              labels: {
                color: textColor,
                padding: 20,
                font: {
                  size: 12
                }
              }
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const total = context.dataset.data.reduce((a, b) => a + b, 0);
                  const porcentaje = ((context.raw / total) * 100).toFixed(1);
                  return `${context.label}: ${context.raw} días (${porcentaje}%)`;
                }
              }
            },
            datalabels: {
              color: textColor,
              font: {
                weight: 'bold',
                size: 12
              },
              formatter: function(value, context) {
                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                const porcentaje = ((value / total) * 100).toFixed(1);
                return value > 0 ? `${value}\n(${porcentaje}%)` : '';
              },
              textAlign: 'center',
              textBaseline: 'middle'
            }
          },
          cutout: '60%',
          animation: {
            animateScale: true,
            animateRotate: true
          }
        }
      });
    };

    const actualizarGraficoEvolucion = () => {
      const registros = JSON.parse(localStorage.getItem('registros') || "[]");
      const categorias = JSON.parse(localStorage.getItem('categorias') || "[]");
      const ejercicios = JSON.parse(localStorage.getItem('ejerciciosGuardados') || "[]");
      
      // Obtener últimos 30 días
      const ahora = new Date();
      const dias = Array.from({length: 30}, (_, i) => {
        const fecha = new Date(ahora);
        fecha.setDate(fecha.getDate() - i);
        return fecha.toLocaleDateString('es-ES', {day: '2-digit', month: '2-digit'});
      }).reverse();

      // Preparar datos para el gráfico
      const datasets = categorias.map((categoria, index) => {
        const datos = dias.map(dia => {
          const registrosDia = registros.filter(r => {
            const ejercicio = ejercicios.find(e => e.nombre === r.ejercicio);
            return r.fecha === dia && ejercicio && ejercicio.categoria === categoria;
          });
          return registrosDia.length > 0 ? 1 : 0;
        });

        return {
          label: categoria,
          data: datos,
          borderColor: colores[index % colores.length],
          backgroundColor: colores[index % colores.length],
          fill: false,
          tension: 0.4,
          pointRadius: 4,
          pointHoverRadius: 6
        };
      });

      const ctx = document.getElementById('graficoEvolucion').getContext('2d');
      
      if (window.graficoEvolucion) {
        window.graficoEvolucion.destroy();
      }

      const isDarkMode = document.documentElement.getAttribute('data-theme') === 'dark';
      const textColor = isDarkMode ? '#ffffff' : '#333333';

      window.graficoEvolucion = new Chart(ctx, {
        type: 'line',
        data: {
          labels: dias,
          datasets: datasets
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'top',
              labels: {
                color: textColor,
                usePointStyle: true,
                padding: 20,
                font: {
                  size: 12
                }
              }
            },
            tooltip: {
              mode: 'index',
              intersect: false,
              callbacks: {
                label: function(context) {
                  const categoria = context.dataset.label;
                  const valor = context.raw;
                  return valor === 1 ? `${categoria}: Entrenado` : `${categoria}: No entrenado`;
                }
              }
            }
          },
          scales: {
            x: {
              grid: {
                display: false
              },
              ticks: {
                color: textColor,
                maxRotation: 45,
                minRotation: 45,
                font: {
                  size: 11
                }
              }
            },
            y: {
              beginAtZero: true,
              max: 1,
              ticks: {
                stepSize: 1,
                color: textColor,
                callback: function(value) {
                  return value === 1 ? 'Sí' : 'No';
                }
              },
              grid: {
                color: isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)'
              }
            }
          },
          interaction: {
            mode: 'nearest',
            axis: 'x',
            intersect: false
          }
        }
      });
    };

    const guardarObjetivo = () => {
      const peso = document.getElementById('objetivo-peso').value;
      const reps = document.getElementById('objetivo-reps').value;
      
      if (!peso || !reps) {
        alert("Por favor, completa ambos campos del objetivo");
        return;
      }

      const objetivo = {
        ejercicio: ejercicioSeleccionado,
        peso: parseFloat(peso),
        reps: parseInt(reps)
      };

      localStorage.setItem(`objetivo_${ejercicioSeleccionado}`, JSON.stringify(objetivo));
      actualizarProgresoObjetivo();
    };

    const actualizarProgresoObjetivo = () => {
      const objetivo = JSON.parse(localStorage.getItem(`objetivo_${ejercicioSeleccionado}`) || "null");
      const contenedor = document.getElementById('progreso-objetivo');
      
      if (!objetivo) {
        contenedor.innerHTML = '<p>No hay objetivo establecido</p>';
        return;
      }

      const registros = JSON.parse(localStorage.getItem('registros') || "[]");
      const registrosEjercicio = registros.filter(r => r.ejercicio === ejercicioSeleccionado);
      
      if (registrosEjercicio.length === 0) {
        contenedor.innerHTML = '<p>No hay registros para comparar</p>';
        return;
      }

      const ultimoRegistro = registrosEjercicio[registrosEjercicio.length - 1];
      const progresoPeso = (ultimoRegistro.peso / objetivo.peso * 100).toFixed(1);
      const progresoReps = (ultimoRegistro.reps / objetivo.reps * 100).toFixed(1);

      contenedor.innerHTML = `
        <div class="progreso-item">
          <div class="progreso-label">Peso: ${ultimoRegistro.peso}kg / ${objetivo.peso}kg</div>
          <div class="progreso-bar">
            <div class="progreso-fill" style="width: ${Math.min(progresoPeso, 100)}%"></div>
          </div>
          <div class="progreso-porcentaje">${progresoPeso}%</div>
        </div>
        <div class="progreso-item">
          <div class="progreso-label">Repeticiones: ${ultimoRegistro.reps} / ${objetivo.reps}</div>
          <div class="progreso-bar">
            <div class="progreso-fill" style="width: ${Math.min(progresoReps, 100)}%"></div>
          </div>
          <div class="progreso-porcentaje">${progresoReps}%</div>
        </div>
      `;
    };

    // Inicialización
    loadTheme();
    cargarCategorias();
    actualizarBotonesEjercicios();
    mostrarUltimosRegistros();
    filtrarEjerciciosPorCategoria('');
  </script>
</body>
</html>